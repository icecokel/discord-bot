const fs = require("fs");
const path = require("path");

const featuresPath = path.join(__dirname, "../src/features");
const registryPath = path.join(__dirname, "../src/core/registry.js");

function generateRegistry() {
  console.log("Generating command registry...");

  if (!fs.existsSync(featuresPath)) {
    console.warn("Features directory not found.");
    return;
  }

  const featureFolders = fs.readdirSync(featuresPath);
  const imports = [];
  const exportList = [];
  let importCounter = 0;

  for (const folder of featureFolders) {
    const commandsPath = path.join(featuresPath, folder, "commands");

    if (fs.existsSync(commandsPath)) {
      const commandFiles = fs
        .readdirSync(commandsPath)
        .filter((file) => file.endsWith(".js"));

      for (const file of commandFiles) {
        const commandName = path.basename(file, ".js").replace(/-/g, "_"); // Sanitizing variable name
        const importName = `cmd_${folder}_${commandName}_${importCounter++}`;

        // Relative path from registry.js to the command file
        // registry.js is in src/core, command is in src/features/<folder>/commands
        const relativePath = `../features/${folder}/commands/${file}`;

        imports.push(`const ${importName} = require('${relativePath}');`);
        exportList.push(importName);

        console.log(`Registered: ${folder}/${file}`);
      }
    }
  }

  const fileContent = `// This file is auto-generated by scripts/generate-registry.js
// Do not edit this file manually.

${imports.join("\n")}

module.exports = {
  commands: [
    ${exportList.join(",\n    ")}
  ]
};
`;

  fs.writeFileSync(registryPath, fileContent);
  console.log(`Registry generated at ${registryPath}`);
}

generateRegistry();
